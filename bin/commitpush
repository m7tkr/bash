#!/usr/bin/env bash

# author: m7tkr
# purpose: add, commit and push git changes
# last modified: 20230620212812
# usage: commitpush <ssh-private-key-path>

# TODO
# use this script w/ ssh-agent loaded
# currently works in ubuntu
# ask for ssh-add password if not specified in cli

# start ssh-agent
eval `ssh-agent`

# get ssh private key
key="$1"
ssh-add "${key:='/home/m7tkr/.ssh/ubuntu_ed25519'}"

# get list of directories
directories="$(find ~/shared -maxdepth 1 -type d)"

# function 
# checks if directory has uncommitted changes
# then commits and pushes upstream
# NOTE: doesn't checks against upstream branch status
for directory in $directories; do
    if [[ $(basename $directory) != "shared" ]]; then
        cd $directory
        if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "$(basename $directory)"
            git push origin
        fi
    fi
done

# stop ssh-agent
eval `ssh-agent -k`
